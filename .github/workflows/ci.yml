name: macOS CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build macOS app
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Ruby (for tools if needed)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      - name: Show Xcode info
        run: |
          xcode-select -p
          xcodebuild -version

      - name: Build with xcodebuild
        env:
          DERIVED_DATA: ${{ github.workspace }}/build
        run: |
          set -e
          # Prefer explicit workspace if present, fall back to project or generic workspace name
          DERIVED="$DERIVED_DATA"
          if [ -f "InjectiPA.xcworkspace" ]; then
            echo "Using InjectiPA.xcworkspace"
            xcodebuild -workspace InjectiPA.xcworkspace \
              -scheme InjectiPA \
              -configuration Release \
              -sdk macosx \
              -derivedDataPath "$DERIVED" \
              CODE_SIGNING_ALLOWED=NO \
              clean build
          elif [ -d "project.xcworkspace" ]; then
            echo "Using project.xcworkspace"
            xcodebuild -workspace project.xcworkspace \
              -scheme InjectiPA \
              -configuration Release \
              -sdk macosx \
              -derivedDataPath "$DERIVED" \
              CODE_SIGNING_ALLOWED=NO \
              clean build
          elif [ -f "InjectiPA.xcodeproj/project.pbxproj" ] || [ -d "InjectiPA.xcodeproj" ]; then
            echo "Using InjectiPA.xcodeproj"
            xcodebuild -project InjectiPA.xcodeproj \
              -scheme InjectiPA \
              -configuration Release \
              -sdk macosx \
              -derivedDataPath "$DERIVED" \
              CODE_SIGNING_ALLOWED=NO \
              clean build
          else
            echo "No workspace or project found in repository root:" >&2
            ls -la
            exit 66
          fi

      - name: Package .app
        env:
          DERIVED_DATA: ${{ github.workspace }}/build
        run: |
          set -e
          APP_PATH="$DERIVED_DATA/Build/Products/Release/InjectiPA.app"
          if [ -d "$APP_PATH" ]; then
            ZIP_PATH="$GITHUB_WORKSPACE/InjectiPA-macos-release.zip"
            /usr/bin/zip -r "$ZIP_PATH" "$APP_PATH"
            echo "ZIPPED=$ZIP_PATH" >> $GITHUB_ENV
          else
            echo "App not found at $APP_PATH" && exit 2
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: InjectiPA-macos-release
          path: InjectiPA-macos-release.zip
